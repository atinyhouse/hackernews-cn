<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HackerNews ä¸­æ–‡çƒ­è®®æ¦œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f6f8fa;
      color: #24292e;
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .search-box {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .search-input {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 20px;
      width: 250px;
      font-size: 0.9rem;
      outline: none;
    }

    .search-btn {
      padding: 0.5rem 1rem;
      background: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      color: #667eea;
      transition: all 0.2s;
    }

    .search-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .date-info {
      background: rgba(255,255,255,0.2);
      padding: 0.3rem 1rem;
      border-radius: 15px;
      font-size: 0.9rem;
    }

    .sort-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .sort-btn {
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.3);
      border: 2px solid transparent;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .sort-btn:hover {
      background: rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }

    .sort-btn.active {
      background: white;
      color: #667eea;
      border-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .main-content {
      margin-top: 2rem;
      padding-bottom: 2rem;
    }

    .stats-bar {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.2rem;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border-left: 4px solid #c33;
    }

    .post-list {
      display: grid;
      gap: 1rem;
    }

    .post-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      border-left: 4px solid #667eea;
    }

    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .post-rank {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
      min-width: 40px;
    }

    .post-title {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 600;
      color: #24292e;
      line-height: 1.4;
    }

    .post-title-cn {
      font-size: 1.1rem;
      font-weight: 600;
      color: #24292e;
      line-height: 1.4;
      margin-bottom: 0.3rem;
    }

    .post-title-en {
      font-size: 0.9rem;
      color: #888;
      line-height: 1.3;
      font-style: italic;
    }

    .post-abstract {
      margin-top: 0.8rem;
      padding: 0.8rem;
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #555;
      line-height: 1.5;
    }

    .post-meta {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.8rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .meta-icon {
      font-size: 1rem;
    }

    .badge {
      background: #667eea;
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge.hot {
      background: #ff6b6b;
    }

    .view-details {
      color: #667eea;
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 2rem;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      margin: 2rem auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e1e4e8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #24292e;
      flex: 1;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0.5rem;
      transition: color 0.2s;
    }

    .close-btn:hover {
      color: #000;
    }

    .modal-body {
      padding: 1.5rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .post-info {
      background: #f6f8fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .post-info-row {
      margin: 0.5rem 0;
    }

    .post-info-label {
      font-weight: 600;
      display: inline-block;
      min-width: 80px;
    }

    .post-url {
      color: #667eea;
      text-decoration: none;
      word-break: break-all;
    }

    .post-url:hover {
      text-decoration: underline;
    }

    .comments-section {
      margin-top: 2rem;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #24292e;
    }

    .comment {
      background: #f6f8fa;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 3px solid #667eea;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #666;
    }

    .comment-author {
      font-weight: 600;
      color: #667eea;
    }

    .comment-content {
      color: #24292e;
      line-height: 1.6;
    }

    .comment.reply {
      margin-left: 2rem;
      border-left-color: #a0aec0;
      background: #f9fafb;
    }

    .no-comments {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .refresh-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    @media (max-width: 768px) {
      .search-input {
        width: 150px;
      }

      .stats-bar {
        flex-direction: column;
        gap: 1rem;
      }

      .post-rank {
        font-size: 1.2rem;
        min-width: 30px;
      }

      .post-title {
        font-size: 1rem;
      }

      .comment.reply {
        margin-left: 1rem;
      }

      .modal {
        padding: 0.5rem;
      }

      .modal-body {
        max-height: 60vh;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo" onclick="location.reload()">
          <span class="logo-icon">ğŸ”¥</span>
          <span>HackerNews Trending</span>
        </div>
        <div class="sort-buttons">
          <button class="sort-btn active" data-sort="comments" onclick="changeSortBy('comments')">
            ğŸ’¬ Most Discussed
          </button>
          <button class="sort-btn" data-sort="points" onclick="changeSortBy('points')">
            ğŸ‘ Top Points
          </button>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Search..." onkeypress="handleSearchKeyPress(event)">
          <button class="search-btn" onclick="handleSearch()">Search</button>
        </div>
        <button class="refresh-btn" onclick="refreshData()">ğŸ”„ Refresh</button>
        <div class="date-info" id="dateInfo">
          ğŸ“… Loading...
        </div>
      </div>
    </div>
  </header>

  <main class="main-content container">
    <div class="stats-bar" id="statsBar">
      <div class="stat-item">
        <div class="stat-number" id="totalPosts">-</div>
        <div class="stat-label">Posts</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="totalComments">-</div>
        <div class="stat-label">Comments</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="totalPoints">-</div>
        <div class="stat-label">Points</div>
      </div>
    </div>

    <div id="loadingIndicator" class="loading">
      <div class="loading-spinner"></div>
      <div>Loading...</div>
    </div>

    <div id="errorMessage" style="display: none;"></div>

    <div class="post-list" id="postList"></div>
  </main>

  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle"></h2>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="post-info" id="modalInfo"></div>
        <div class="comments-section">
          <h3 class="section-title">ğŸ’¬ è¯„è®º</h3>
          <div id="commentsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // é™æ€æ•°æ®æ–‡ä»¶è·¯å¾„
    const DATA_FILE = './data/posts.json';

    let allPosts = []; // æ‰€æœ‰å¸–å­æ•°æ®
    let currentPosts = [];
    let isSearchMode = false;
    let currentSortBy = 'comments'; // é»˜è®¤æŒ‰è¯„è®ºæ•°æ’åº
    let lastUpdate = null;

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      return `${days}å¤©å‰`;
    }

    // æ ¼å¼åŒ–æ•°å­—
    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toString();
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      const totalComments = allPosts.reduce((sum, p) => sum + (p.comments?.length || 0), 0);
      const totalPoints = allPosts.reduce((sum, p) => sum + p.points, 0);

      document.getElementById('totalPosts').textContent = allPosts.length;
      document.getElementById('totalComments').textContent = formatNumber(totalComments);
      document.getElementById('totalPoints').textContent = formatNumber(totalPoints);

      if (lastUpdate) {
        const timeAgo = formatTime(lastUpdate);
        const date = new Date(lastUpdate);
        const dateStr = date.toLocaleString('zh-CN', {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('dateInfo').textContent = `ğŸ• ${timeAgo}æ›´æ–° (${dateStr})`;
      }
    }

    // åŠ è½½å¸–å­æ•°æ®
    async function loadPosts() {
      try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('postList').innerHTML = '';

        const response = await fetch(DATA_FILE);
        const data = await response.json();

        allPosts = data.posts.map((post, index) => ({
          ...post,
          id: index + 1, // æ·»åŠ ä¸€ä¸ª ID ç”¨äºè¯¦æƒ…é¡µ
          comment_count: post.comments?.length || 0
        }));
        lastUpdate = data.lastUpdate;

        applySortAndRender();
        updateStats();
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showError('æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿æ•°æ®æ–‡ä»¶å·²ç”Ÿæˆ');
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }

    // åº”ç”¨æ’åºå¹¶æ¸²æŸ“
    function applySortAndRender() {
      let sorted = [...allPosts];

      if (currentSortBy === 'comments') {
        sorted.sort((a, b) => b.comment_count - a.comment_count);
      } else if (currentSortBy === 'points') {
        sorted.sort((a, b) => b.points - a.points);
      }

      currentPosts = sorted.slice(0, 20); // åªæ˜¾ç¤ºå‰20æ¡
      renderPosts(currentPosts);
    }

    // åˆ‡æ¢æ’åºæ–¹å¼
    function changeSortBy(sortBy) {
      if (currentSortBy === sortBy) return;

      currentSortBy = sortBy;
      isSearchMode = false;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.sort-btn').forEach(btn => {
        if (btn.dataset.sort === sortBy) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      applySortAndRender();
    }

    // æ¸²æŸ“å¸–å­åˆ—è¡¨
    function renderPosts(posts) {
      const postList = document.getElementById('postList');

      if (posts.length === 0) {
        postList.innerHTML = '<div class="no-comments">æš‚æ— æ•°æ®</div>';
        return;
      }

      postList.innerHTML = posts.map((post, index) => {
        const isHot = post.comment_count > 100;
        const timeAgo = formatTime(post.created_at);

        // ä¼˜å…ˆæ˜¾ç¤ºä¸­æ–‡æ ‡é¢˜
        const titleDisplay = post.title_cn
          ? `<div class="post-title-cn">${escapeHtml(post.title_cn)}</div>
             <div class="post-title-en">${escapeHtml(post.title)}</div>`
          : `<div class="post-title">${escapeHtml(post.title)}</div>`;

        // æ˜¾ç¤ºæ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
        const abstractDisplay = post.abstract
          ? `<div class="post-abstract">ğŸ“ ${escapeHtml(post.abstract)}</div>`
          : '';

        return `
          <div class="post-card" onclick="window.location.href='post.html?id=${post.id}'">
            <div class="post-header">
              <div class="post-rank">#${index + 1}</div>
              <div style="flex: 1;">
                ${titleDisplay}
                <div class="post-meta">
                  <div class="meta-item">
                    <span class="meta-icon">ğŸ‘</span>
                    <span>${post.points} points</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-icon">ğŸ’¬</span>
                    <span>${post.comment_count} comments</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-icon">ğŸ‘¤</span>
                    <span>${post.author}</span>
                  </div>
                  <div class="meta-item">
                    <span class="meta-icon">ğŸ•</span>
                    <span>${timeAgo}</span>
                  </div>
                  ${isHot ? '<span class="badge hot">ğŸ”¥ Hot</span>' : ''}
                </div>
                ${abstractDisplay}
              </div>
            </div>
            <div class="view-details">View details â†’</div>
          </div>
        `;
      }).join('');
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.className = 'error';
      errorDiv.textContent = 'âŒ ' + message;
      errorDiv.style.display = 'block';
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ‰“å¼€è¯¦æƒ…æ¨¡æ€æ¡†
    async function openModal(postId) {
      try {
        const post = allPosts.find(p => p.id === postId);
        if (!post) {
          alert('å¸–å­ä¸å­˜åœ¨');
          return;
        }

        const comments = post.comments || [];

        document.getElementById('modalTitle').textContent = post.title;

        const timeAgo = formatTime(post.created_at);
        document.getElementById('modalInfo').innerHTML = `
          <div class="post-info-row">
            <span class="post-info-label">ğŸ‘ ç‚¹èµæ•°:</span>
            <span>${post.points}</span>
          </div>
          <div class="post-info-row">
            <span class="post-info-label">ğŸ’¬ è¯„è®ºæ•°:</span>
            <span>${post.comment_count}</span>
          </div>
          <div class="post-info-row">
            <span class="post-info-label">ğŸ‘¤ ä½œè€…:</span>
            <span>${post.author}</span>
          </div>
          <div class="post-info-row">
            <span class="post-info-label">ğŸ• å‘å¸ƒæ—¶é—´:</span>
            <span>${timeAgo}</span>
          </div>
          <div class="post-info-row">
            <span class="post-info-label">ğŸ”— åŸæ–‡é“¾æ¥:</span>
            <a href="${post.url}" target="_blank" class="post-url">è®¿é—®åŸæ–‡ â†—</a>
          </div>
        `;

        console.log('è¯„è®ºæ•°é‡:', comments.length);
        if (comments.length === 0) {
          document.getElementById('commentsList').innerHTML = '<div class="no-comments">æš‚æ— è¯„è®º</div>';
        } else {
          // æ„å»ºè¯„è®ºæ ‘
          const commentTree = buildCommentTree(comments);
          console.log('æ ¹è¯„è®ºæ•°é‡:', commentTree.length);
          const renderedHtml = renderComments(commentTree);
          console.log('æ¸²æŸ“çš„ HTML é•¿åº¦:', renderedHtml.length);
          document.getElementById('commentsList').innerHTML = renderedHtml;
        }

        document.getElementById('detailModal').classList.add('active');
        document.body.style.overflow = 'hidden';

      } catch (error) {
        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½è¯¦æƒ…å¤±è´¥');
      }
    }

    // æ„å»ºè¯„è®ºæ ‘
    function buildCommentTree(comments) {
      const commentMap = {};
      const rootComments = [];

      // åˆ›å»ºè¯„è®ºæ˜ å°„
      comments.forEach(comment => {
        commentMap[comment.hn_comment_id] = {
          ...comment,
          children: []
        };
      });

      // æ„å»ºæ ‘ç»“æ„
      comments.forEach(comment => {
        if (comment.parent_id && commentMap[comment.parent_id]) {
          commentMap[comment.parent_id].children.push(commentMap[comment.hn_comment_id]);
        } else {
          rootComments.push(commentMap[comment.hn_comment_id]);
        }
      });

      return rootComments;
    }

    // æ¸²æŸ“è¯„è®ºæ ‘
    function renderComments(comments, isReply = false) {
      return comments.map(comment => {
        const timeAgo = formatTime(comment.created_at);
        const childrenHtml = comment.children.length > 0
          ? renderComments(comment.children, true)
          : '';

        // ä¼˜å…ˆæ˜¾ç¤ºä¸­æ–‡å†…å®¹ï¼Œå¹¶è½¬ä¹‰ HTML
        const contentDisplay = comment.content_cn
          ? `<div class="comment-content">${escapeHtml(comment.content_cn)}</div>
             <div class="comment-content" style="font-size: 0.85rem; color: #999; margin-top: 0.5rem; font-style: italic;">${escapeHtml(comment.content)}</div>`
          : `<div class="comment-content">${escapeHtml(comment.content)}</div>`;

        return `
          <div class="comment ${isReply ? 'reply' : ''}">
            <div class="comment-header">
              <span class="comment-author">${escapeHtml(comment.author)}</span>
              <span>${timeAgo}</span>
            </div>
            ${contentDisplay}
          </div>
          ${childrenHtml}
        `;
      }).join('');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // æœç´¢åŠŸèƒ½
    async function handleSearch() {
      const keyword = document.getElementById('searchInput').value.trim();

      if (!keyword) {
        if (isSearchMode) {
          isSearchMode = false;
          applySortAndRender();
        }
        return;
      }

      isSearchMode = true;
      const searchResults = allPosts.filter(post =>
        post.title.toLowerCase().includes(keyword.toLowerCase()) ||
        (post.title_cn && post.title_cn.toLowerCase().includes(keyword.toLowerCase()))
      );

      currentPosts = searchResults.slice(0, 20);
      renderPosts(currentPosts);

      if (currentPosts.length === 0) {
        showError(`æœªæ‰¾åˆ°åŒ…å«"${keyword}"çš„å¸–å­`);
      }
    }

    // æœç´¢æ¡†å›è½¦äº‹ä»¶
    function handleSearchKeyPress(event) {
      if (event.key === 'Enter') {
        handleSearch();
      }
    }

    // åˆ·æ–°æ•°æ®(é™æ€ç‰ˆæœ¬ä¸æ”¯æŒ)
    async function refreshData() {
      alert('GitHub Pages ç‰ˆæœ¬æ¯å¤©ä¼šè‡ªåŠ¨æ›´æ–°æ•°æ®,æ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚æ•°æ®å°†åœ¨åŒ—äº¬æ—¶é—´æ¯å¤© 8:00 è‡ªåŠ¨æ›´æ–°ã€‚');
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('detailModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // åˆå§‹åŒ–åŠ è½½
    window.addEventListener('DOMContentLoaded', () => {
      loadPosts();
    });
  </script>
</body>
</html>
